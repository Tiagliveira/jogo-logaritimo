/**
 * Projeto: Jogo Logoritmos
 * Autor: Tiago Oliveira
 * Descri√ß√£o: Script principal do jogo ‚Äî controle de telas, cadastro, login, hist√≥rico e anima√ß√µes
 * √öltima atualiza√ß√£o: 25/09/2025
 */
const API_URL = location.hostname === "localhost"
  ? "http://localhost:3000"
  : "https://jogo-logaritimo-api.vercel.app";
// ===============================
// Vari√°veis globais do jogo
// ===============================
let telaEmTransicao = false; // Controla se h√° uma transi√ß√£o de tela em andamento
let currentLevel = 1;        // N√≠vel atual do jogador
let lives = 3;               // N√∫mero de vidas restantes
let number = 0;              // N√∫mero secreto do n√≠vel
let attempts = 0;            // Tentativas feitas no n√≠vel atual
let numberOfGuesses = 0;     // Total de palpites feitos
let history = [];            // Hist√≥rico de palpites
let nome = "";               // Nome do jogador
let historicalShow = true;   // Exibe hist√≥rico no modo f√°cil
let estadoDeTransicao = false; // Estado de transi√ß√£o visual
let confeteInterval, coracaoInterval, gameOverInterval, TrofeuInterval, coroaInterval; // Efeitos visuais

// ==================================================
// FUN√á√ÉO: transicaoDeTela
// Descri√ß√£o: Realiza a transi√ß√£o visual entre duas telas com fade-out e fade-in
// ==================================================
function transicaoDeTela(telaAtualId, proximaTelaId) {
  telaEmTransicao = true;

  const atual = document.getElementById(telaAtualId);
  const proxima = document.getElementById(proximaTelaId);

  if (!atual || !proxima) return;

  atual.classList.add("fade-out");

  setTimeout(() => {
    atual.style.display = "none";
    atual.classList.remove("fade-out");

    proxima.style.display = "block";
    proxima.classList.add("fade-in");

    setTimeout(() => {
      proxima.classList.remove("fade-in");
      telaEmTransicao = false;
    }, 1000);
  }, 1000);
}

// ==================================================
// FUN√á√ÉO: atualizarBotao
// Descri√ß√£o: Alterna entre "Login" e "Cadastrar usu√°rio" com base no checkbox
// ==================================================
function atualizarBotao() {
  const checkbox = document.getElementById("logarDireto");
  const botao = document.getElementById("botaoPrincipal");

  if (checkbox.checked) {
    botao.textContent = "Login";
    botao.onclick = login;
  } else {
    botao.textContent = "Cadastrar usu√°rio";
    botao.onclick = cadastrar;
  }
}

// ==================================================
// FUN√á√ÉO: cadastrar
// Descri√ß√£o: Cadastra novo jogador, gera avatar, envia dados ao backend e atualiza interface
// ==================================================
async function cadastrar() {
  const nomeInput = document.getElementById("nome");
  const nome = nomeInput?.value.trim();
  const logarDireto = document.getElementById("logarDireto")?.checked;
  const mensagem = document.getElementById("mensagemCadastro");
  const avatarCadastro = document.getElementById("avatarCadastro");

  if (!nome || nome.length < 3) {
    alert("Digite um nome v√°lido com pelo menos 3 caracteres!");
    return;
  }

  const estilos = ["bottts", "adventurer", "fun-emoji", "lorelei", "thumbs", "shapes", "notionists"];
  const estiloAleatorio = estilos[Math.floor(Math.random() * estilos.length)];
  const avatarUrl = `https://api.dicebear.com/7.x/${estiloAleatorio}/png?seed=${encodeURIComponent(nome)}`;

  let respostaCadastro;
  try {
    respostaCadastro = await fetch(`${API_URL}/api/cadastro`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ id: nome, avatar: avatarUrl }),
    });
  } catch (err) {
    mensagem.textContent = "üö´ Erro de conex√£o com o servidor";
    mensagem.style.color = "red";
    return;
  }

  const texto = await respostaCadastro.text();

  if (respostaCadastro.ok) {
    mensagem.textContent = "‚úÖ " + texto;
    mensagem.style.color = "green";

    localStorage.setItem("estadoTela", "boasVindas");
    localStorage.setItem("avatarJogador", avatarUrl);
    localStorage.setItem("nomeJogador", nome);

    const nomeJogador = document.getElementById("nomeJogador");
    if (nomeJogador) nomeJogador.textContent = `üë§ Jogador: ${nome}`;

    const avatarBoasVindas = document.getElementById("avatarBoasVindas");
    const imgTemp = new Image();
    imgTemp.onload = () => {
      if (avatarBoasVindas) {
        avatarBoasVindas.src = avatarUrl;
        avatarBoasVindas.style.display = "block";
      }
      transicaoDeTela("formulario", "welcomeArea");
    };
    imgTemp.src = avatarUrl;

    if (avatarCadastro) {
      avatarCadastro.src = avatarUrl;
      avatarCadastro.style.display = "block";
    }

    const avatarJogo = document.getElementById("avatarJogo");
    if (avatarJogo) {
      avatarJogo.src = avatarUrl;
      avatarJogo.style.display = "block";
    }

    salvarHistorico(nome, ["5", "8", "3"]);
    nomeInput.value = nome;

    await login(); // login autom√°tico
  } else if (texto === "Usu√°rio j√° existe") {
    mensagem.textContent = "‚ö†Ô∏è Usu√°rio j√° existe. Escolha outro nome.";
    mensagem.style.color = "orange";
    nomeInput.value = "";
    if (avatarCadastro) avatarCadastro.style.display = "none";
    if (document.getElementById("logarDireto")) {
      document.getElementById("logarDireto").checked = false;
    }
    atualizarBotao();
  } else {
    mensagem.textContent = "‚ö†Ô∏è " + texto;
    mensagem.style.color = "red";
    if (avatarCadastro) avatarCadastro.style.display = "none";
  }
}

// ==================================================
// FUN√á√ÉO: login
// Descri√ß√£o: Realiza login do jogador e atualiza interface com dados do servidor
// ==================================================
async function login() {
  const nome = document.getElementById("nome")?.value.trim();
  const mensagem = document.getElementById("mensagemCadastro");
  const avatarJogo = document.getElementById("avatarJogo");

  let respostaLogin;
  try {
    respostaLogin = await fetch(`${API_URL}/api/login`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ id: nome }),
    });
  } catch (err) {
    mensagem.textContent = "üö´ Erro de conex√£o com o servidor";
    mensagem.style.color = "red";
    return;
  }

  try {
    const dados = await respostaLogin.json();

    currentLevel = dados.dados.nivel;
    lives = typeof dados.dados.vidas === "number" ? dados.dados.vidas : 3;
    atualizarVidas();

    mensagem.textContent = "üõ∏ " + dados.mensagem;
    mensagem.style.color = "blue";

    if (dados.dados.avatar) {
      if (avatarJogo) {
        avatarJogo.src = dados.dados.avatar;
        avatarJogo.style.display = "block";
      }
      localStorage.setItem("avatarJogador", dados.dados.avatar);
      localStorage.setItem("nomeJogador", nome);
    }

    const avatarBoasVindas = document.getElementById("avatarBoasVindas");
    if (avatarBoasVindas) {
      avatarBoasVindas.src = dados.dados.avatar;
      avatarBoasVindas.style.display = "block";
    }

    const nomeJogador = document.getElementById("nomeJogador");
    if (nomeJogador) nomeJogador.textContent = `Ol√° ${nome}`;

    document.querySelector(".formulario").style.display = "none";
    document.getElementById("welcomeArea").style.display = "block";
  } catch (err) {
    const texto = await respostaLogin.text();
    mensagem.textContent = "üö´ " + texto;
    mensagem.style.color = "red";
    if (avatarJogo) avatarJogo.style.display = "none";
    console.log("Resposta do servidor:", respostaLogin.status);
  }

  try {
    await carregarRanking();
  } catch (err) {
    console.warn("Erro ao carregar ranking:", err);
  }
}

// ==================================================
// FUN√á√ÉO: salvarHistorico
// Descri√ß√£o: Envia hist√≥rico de palpites para o servidor (ranking e modo f√°cil)
// ==================================================
async function salvarHistorico(nomeDoJogador, palpites) {
  if (!nomeDoJogador || !Array.isArray(palpites)) {
    console.warn("Dados inv√°lidos para salvar hist√≥rico");
    return;
  }

  try {
    const resposta = await fetch(`${API_URL}/api/salvar-historico`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        id: nomeDoJogador,
        historico: palpites,
      }),
    });

    if (!resposta.ok) {
      const erro = await resposta.text();
      console.warn("Erro ao salvar hist√≥rico:", erro);
    } else {
      console.log("üìö Hist√≥rico salvo com sucesso para", nomeDoJogador);
    }
  } catch (err) {
    console.error("üö´ Falha na comunica√ß√£o com o servidor:", err);
  }
}

// ==================================================
// EVENTO: DOMContentLoaded
// Descri√ß√£o: Executa ao carregar a p√°gina e exibe a tela correta com base no localStorage
// ==================================================
window.addEventListener("DOMContentLoaded", async () => {
  if (typeof telaEmTransicao !== "undefined" && telaEmTransicao) return;

  atualizarBotao();

  const estado = localStorage.getItem("estadoTela");
  const nome = localStorage.getItem("nomeJogador");

  if (nome) {
    document.getElementById("nome").value = nome;
  }

  try {
    if (estado === "jogo" && nome) {
      await login();
      document.getElementById("welcomeArea").style.display = "none";
      document.getElementById("gameArea").style.display = "block";
      iniciarNivel();
    } else if (estado === "boasVindas" && nome) {
      document.querySelector(".formulario").style.display = "none";
      document.getElementById("welcomeArea").style.display = "block";
    } else {
      // Estado inicial
      document.querySelector(".formulario").style.display = "block";
      document.getElementById("welcomeArea").style.display = "none";
      document.getElementById("gameArea").style.display = "none";
    }
  } catch (err) {
    console.error("üö´ Erro ao restaurar estado da tela:", err);
    // fallback para estado inicial
    document.querySelector(".formulario").style.display = "block";
    document.getElementById("welcomeArea").style.display = "none";
    document.getElementById("gameArea").style.display = "none";
  }
});

// ==================================================
// FUN√á√ÉO: entrarNoJogo
// Descri√ß√£o: Inicia o jogo ap√≥s o jogador escolher o modo e preencher o nome
// ==================================================
function entrarNoJogo() {
  const nomeInput = document.getElementById("nome");
  const nome = nomeInput?.value.trim();

  if (!nome || nome.length < 3) {
    alert("Digite um nome v√°lido com pelo menos 3 caracteres!");
    return;
  }

  // Salva estado e modo de jogo
  localStorage.setItem("estadoTela", "jogo");
  localStorage.setItem("nomeJogador", nome);

  const modoSelecionado = document.querySelector('input[name="modo"]:checked')?.value;
  if (!modoSelecionado) {
    alert("Selecione um modo de jogo!");
    return;
  }

  localStorage.setItem("modoJogo", modoSelecionado);
  historicalShow = modoSelecionado === "facil";

  // Exibe tela do jogo e oculta as demais
  document.querySelector(".formulario")?.style.setProperty("display", "none");
  document.getElementById("welcomeArea")?.style.setProperty("display", "none");
  document.getElementById("gameArea")?.style.setProperty("display", "block");

  // Sincroniza avatar e nome
  const avatarUrl = localStorage.getItem("avatarJogador");
  const avatarJogo = document.getElementById("avatarJogo");
  if (avatarJogo && avatarUrl) {
    avatarJogo.src = avatarUrl;
    avatarJogo.style.display = "block";
  }

  const nomeJogador = document.getElementById("nomeJogador");
  if (nomeJogador) {
    nomeJogador.textContent = `üë§ Jogador: ${nome}`;
  }

  // Inicia l√≥gica do jogo
  try {
    iniciarNivel();
    atualizarVidas();
    carregarRanking();
  } catch (err) {
    console.error("üö´ Erro ao iniciar o jogo:", err);
    alert("Ocorreu um erro ao iniciar o jogo. Tente novamente.");
  }
}

// ==================================================
// FUN√á√ÉO: sairDoJogo
// Descri√ß√£o: Retorna √† tela de cadastro e limpa dados visuais
// ==================================================
function sairDoJogo() {
  // Atualiza estado da tela para voltar ao formul√°rio
  localStorage.setItem("estadoTela", "formulario");

  // Oculta √°reas do jogo e boas-vindas
  document.getElementById("gameArea")?.style.setProperty("display", "none");
  document.getElementById("welcomeArea")?.style.setProperty("display", "none");

  // Exibe formul√°rio de entrada
  document.querySelector(".formulario")?.style.setProperty("display", "block");

  // Limpa apenas a interface visual (n√£o os dados do jogador)
  const vidasContainer = document.getElementById("vidasContainer");
  if (vidasContainer) vidasContainer.textContent = "";

  // N√ÉO zera currentLevel, lives, hist√≥rico ou avatar
  // Esses dados permanecem salvos no localStorage e backend

  console.log("üëã Jogador saiu do jogo, dados preservados");
}

// ==================================================
// EVENTO: DOMContentLoaded
// Descri√ß√£o: Executa ao carregar a p√°gina e restaura estado salvo
// ==================================================
window.addEventListener("DOMContentLoaded", async () => {
  atualizarBotao();

  const estado = localStorage.getItem("estadoTela");
  const nome = localStorage.getItem("nomeJogador");
  const avatar = localStorage.getItem("avatarJogador");

  // Sempre tenta carregar o ranking, mesmo fora do jogo
  try {
    await carregarRanking();
  } catch (err) {
    console.warn("‚ö†Ô∏è Erro ao carregar ranking:", err);
  }

  if (estado === "jogo" && nome && avatar) {
    document.querySelector(".formulario")?.style.setProperty("display", "none");
    document.getElementById("welcomeArea")?.style.setProperty("display", "none");
    document.getElementById("gameArea")?.style.setProperty("display", "block");

    const avatarJogo = document.getElementById("avatarJogo");
    if (avatarJogo) {
      avatarJogo.src = avatar;
      avatarJogo.style.display = "block";
    }

    const nomeJogador = document.getElementById("nomeJogador");
    if (nomeJogador) {
      nomeJogador.textContent = `üë§ Jogador: ${nome}`;
    }

    try {
      await login(); // garante que dados do backend estejam atualizados
      iniciarNivel();
      atualizarVidas();
    } catch (err) {
      console.error("üö´ Erro ao restaurar sess√£o do jogador:", err);
      alert("Ocorreu um erro ao restaurar seu jogo. Tente novamente.");
      localStorage.setItem("estadoTela", "formulario");
      document.querySelector(".formulario")?.style.setProperty("display", "block");
      document.getElementById("gameArea")?.style.setProperty("display", "none");
    }
  }
});


// ==================================================
// FUN√á√ÉO: carregarRanking
// Descri√ß√£o: Busca ranking do servidor e atualiza Top 3 e lista completa
// ==================================================
async function carregarRanking() {
  try {
    const resposta = await fetch(`${API_URL}/api/ranking`);
    if (!resposta.ok) throw new Error("Resposta inv√°lida do servidor");

    const ranking = await resposta.json();
    const nomeAtual = localStorage.getItem("nomeJogador");

    const trofeus = ["ü•á", "ü•à", "ü•â"];
    const simbolosExtras = ["üéñÔ∏è", "üéóÔ∏è", "‚≠ê", "üåü", "üî∞", "ü™ê", "üöÄ"];

    // Atualiza Top 3
    const topRanking = document.getElementById("topRanking");
    if (topRanking) {
      topRanking.innerHTML = "";
      ranking.slice(0, 3).forEach((jogador, index) => {
        const li = document.createElement("li");
        li.innerHTML = `
          <div class="miniRanking">
            <p class="trofeu">${trofeus[index]}</p>
            <div class="avatarMiniRanking">
              <img src="${jogador.avatar}" alt="Avatar de ${jogador.id}">
            </div>
            ${jogador.id} - N√≠vel M√°ximo ${jogador.nivelMaximo}
          </div>
        `;
        topRanking.appendChild(li);
      });
    }

    // Atualiza ranking completo
    const listaCompleta = document.getElementById("listaRankingCompleto");
    if (listaCompleta) {
      listaCompleta.innerHTML = "";
      ranking.forEach((jogador, index) => {
        const li = document.createElement("li");

        if (jogador.id === nomeAtual) {
          Object.assign(li.style, {
            backgroundColor: "#ff0000",
            fontWeight: "bold",
            color: "white",
            borderRadius: "50px",
            border: "2px solid black"
          });
        }

        const simbolo =
          index < 3 ? trofeus[index] :
          index < 10 ? simbolosExtras[index - 3] :
          "";

        li.innerHTML = `
          <div class="RankingGeal">
            <p class="simbolos">${simbolo}</p>
            <div class="avatarRankingGeral">
              <img src="${jogador.avatar}" alt="Avatar de ${jogador.id}">
            </div>
            ${jogador.id} - N√≠vel M√°ximo ${jogador.nivelMaximo}
          </div>
        `;
        listaCompleta.appendChild(li);
      });
    }
  } catch (err) {
    console.error("üö´ Erro ao carregar ranking:", err);
    const listaCompleta = document.getElementById("listaRankingCompleto");
    if (listaCompleta) {
      listaCompleta.innerHTML = "<li>‚ö†Ô∏è N√£o foi poss√≠vel carregar o ranking.</li>";
    }
  }
}

// ==================================================
// FUN√á√ïES: mostrarRankingCompleto / fecharRanking
// Descri√ß√£o: Controlam exibi√ß√£o da tela de ranking com anima√ß√£o
// ==================================================
function mostrarRankingCompleto() {
  const ranking = document.getElementById("rankingCompleto");
  if (!ranking) return;

  ranking.classList.remove("fade-out");
  ranking.classList.add("fade-in");
  ranking.style.display = "block";
}

function fecharRanking() {
  const ranking = document.getElementById("rankingCompleto");
  if (!ranking) return;

  ranking.classList.remove("fade-in");
  ranking.classList.add("fade-out");

  // Aguarda o fim da anima√ß√£o para esconder o elemento
  setTimeout(() => {
    ranking.style.display = "none";
  }, 300); // tempo deve bater com a dura√ß√£o da anima√ß√£o CSS
}


// ==================================================
// FUN√á√ÉO: atualizarVidas
// Descri√ß√£o: Atualiza visual dos cora√ß√µes com base nas vidas restantes
// ==================================================
function atualizarVidas() {
  const container = document.getElementById("vidasContainer");
  if (!container) return;

  const coracaoCheio = "‚ù§Ô∏è";
  const coracaoVazio = "ü§ç";
  const totalVidas = 3;

  const vidasAtuais = typeof lives === "number" ? lives : 0;
  const coracoes = Array.from({ length: totalVidas }, (_, i) =>
    i < vidasAtuais ? coracaoCheio : coracaoVazio
  ).join("");

  container.textContent = coracoes;
}

// ==================================================
// FUN√á√ÉO: reiniciarJogo
// Descri√ß√£o: Reinicia o jogo ap√≥s Game Over e reseta estado
// ==================================================
async function reiniciarJogo() {
  pararGameOverLoop?.();
  pararCoroaLoop?.();

  currentLevel = 1;
  lives = 3;
  estadoDeTransicao = false;

  atualizarVidas();
  iniciarNivel();

  document.getElementById("palpite")?.removeAttribute("disabled");
  document.getElementById("enviarPalpite")?.removeAttribute("disabled");

  const nomeJogador = localStorage.getItem("nomeJogador");
  if (!nomeJogador) {
    console.warn("‚ö†Ô∏è Nome do jogador n√£o encontrado no localStorage");
    return;
  }

  try {
    const resposta = await fetch(`${API_URL}/api/reiniciar-nivel`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ id: nomeJogador }),
    });

    if (!resposta.ok) {
      const erro = await resposta.text();
      console.error("üö´ Erro ao reiniciar n√≠vel:", erro);
    }
  } catch (err) {
    console.error("üö´ Falha na comunica√ß√£o com o servidor:", err);
  }

  transicaoDeTela("gameOverArea", "gameArea");
}

// ==================================================
// FUN√á√ÉO: continuarJogo
// Descri√ß√£o: Continua o jogo ap√≥s perder uma vida e atualiza servidor
// ==================================================
async function continuarJogo() {
  estadoDeTransicao = false;
  pararCoracaoLoop?.();

  const nomeJogador = localStorage.getItem("nomeJogador");
  if (!nomeJogador) {
    console.warn("‚ö†Ô∏è Nome do jogador n√£o encontrado no localStorage");
    return;
  }

  try {
    const resposta = await fetch(`${API_URL}/api/atualizar-nivel`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        id: nomeJogador,
        nivelAtual: currentLevel,
        vidas: lives,
      }),
    });

    if (!resposta.ok) {
      const erro = await resposta.text();
      console.error("üö´ Erro ao atualizar n√≠vel:", erro);
    }
  } catch (err) {
    console.error("üö´ Falha na comunica√ß√£o com o servidor:", err);
  }

  iniciarNivel();
  transicaoDeTela("vidaPerdidaArea", "gameArea");
}

// ==================================================
// FUN√á√ÉO: limparInputPalpite
// Descri√ß√£o: Limpa o campo de input do palpite
// ==================================================
function limparInputPalpite() {
  const input = document.getElementById("palpite");
  if (input) input.value = "";
}

// ==================================================
// FUN√á√ÉO: continuarVitoria
// Descri√ß√£o: Avan√ßa para o pr√≥ximo n√≠vel ap√≥s vit√≥ria
// ==================================================
async function continuarVitoria() {
  estadoDeTransicao = false;
  pararConfetesLoop?.();
  pararTrofeuLoop?.();

  const nomeJogador = localStorage.getItem("nomeJogador");
  if (!nomeJogador) {
    console.warn("‚ö†Ô∏è Nome do jogador n√£o encontrado no localStorage");
    return;
  }

  try {
    const resposta = await fetch(`${API_URL}/api/atualizar-nivel`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        id: nomeJogador,
        nivelAtual: currentLevel,
        vidas: lives,
      }),
    });

    if (!resposta.ok) {
      const erro = await resposta.text();
      console.error("üö´ Erro ao atualizar n√≠vel ap√≥s vit√≥ria:", erro);
    } else {
      await carregarRanking();
    }
  } catch (err) {
    console.error("üö´ Falha na comunica√ß√£o com o servidor:", err);
  }

  transicaoDeTela("vitoriaArea", "gameArea");

  // Aguarda fim da anima√ß√£o antes de iniciar novo n√≠vel
  setTimeout(() => {
    iniciarNivel();
  }, 1000);
}

// ==================================================
// FUN√á√ïES: mostrarRankingCompleto / voltarDoRanking
// Descri√ß√£o: Controlam transi√ß√£o entre tela de jogo e ranking
// ==================================================
function mostrarRankingCompleto() {
  const rankingArea = document.getElementById("rankingArea");
  const gameArea = document.getElementById("gameArea");

  if (rankingArea && gameArea) {
    transicaoDeTela("gameArea", "rankingArea");
  } else {
    console.warn("‚ö†Ô∏è √Åreas de ranking ou jogo n√£o encontradas.");
  }
}

function voltarDoRanking() {
  const rankingArea = document.getElementById("rankingArea");
  const gameArea = document.getElementById("gameArea");

  if (rankingArea && gameArea) {
    localStorage.setItem("estadoTela", "jogo");
    transicaoDeTela("rankingArea", "gameArea");
  } else {
    console.warn("‚ö†Ô∏è √Åreas de ranking ou jogo n√£o encontradas.");
  }
}

// ==================================================
// FUN√á√ïES DE EFEITO VISUAL: Confetes, Cora√ß√£o, Game Over, Trof√©u, Coroa
// Descri√ß√£o: Criam e controlam anima√ß√µes visuais durante o jogo
// ==================================================
function estourarConfetes() {
  const container = document.getElementById("confeteExplosao");
  container.innerHTML = "";

  for (let i = 0; i < 40; i++) {
    const confete = document.createElement("span");
    confete.style.left = Math.random() * 100 + "%";
    confete.style.top = Math.random() * 20 + "%";
    confete.style.setProperty("--hue", Math.floor(Math.random() * 360));
    container.appendChild(confete);
  }

  setTimeout(() => {
    container.innerHTML = "";
  }, 2000);
}

function iniciarConfetesLoop() {
  estourarConfetes(); // dispara imediatamente
  confeteInterval = setInterval(estourarConfetes, 5000);
}

function pararConfetesLoop() {
  clearInterval(confeteInterval);
}

function estourarCoracao() {
  const el = document.getElementById("explosaoCoracao");
  el.innerHTML = ""; // limpa antes de criar novo

  const heart = document.createElement("span");
  heart.textContent = "üíî";
  heart.classList.add("coracaoAnimado");

  void heart.offsetWidth;// Reinicia anima√ß√£o
  el.appendChild(heart);

  setTimeout(() => {
    heart.remove();
  }, 1200);
}

function iniciarCoracaoLoop() {
  estourarCoracao(); // dispara imediatamente
  coracaoInterval = setInterval(estourarCoracao, 3000); // repete a cada 3s
}

function pararCoracaoLoop() {
  clearInterval(coracaoInterval);
}

function estourarGameOver() {
  const el = document.getElementById("explosaoGameOver");
  el.innerHTML = "";

  const ghost = document.createElement("span");
  ghost.textContent = "üëª"; // ou "üíÄ"
  ghost.classList.add("gameOverAnimado");

  void ghost.offsetWidth;

  el.appendChild(ghost);

  setTimeout(() => {
    ghost.remove();
  }, 2000);
}

function iniciarGameOverLoop() {
  estourarGameOver();
  gameOverInterval = setInterval(estourarGameOver, 3000);
}

function pararGameOverLoop() {
  clearInterval(gameOverInterval);
}

function estourarTrofeu() {
  const el = document.getElementById("explosaoTrofeu");
  el.innerHTML = "";

  const trofeu = document.createElement("span");
  trofeu.textContent = "üèÜ";
  trofeu.classList.add("trofeuAnimado");

  void trofeu.offsetWidth;

  el.appendChild(trofeu);

  setTimeout(() => {
    el.innerHTML = "";
  }, 1500);
}

function iniciarTrofeuLoop() {
  estourarTrofeu(); // dispara imediatamente
  TrofeuInterval = setInterval(estourarTrofeu, 3000); // repete a cada 3s
}

function pararTrofeuLoop() {
  clearInterval(TrofeuInterval);
}

function estourarCoroaFinal() {
  const el = document.getElementById("explosaoCoroa");
  el.innerHTML = "";

  const coroa = document.createElement("span");
  coroa.textContent = "üëë";
  coroa.classList.add("coroaAnimada");

  void coroa.offsetWidth;

  el.appendChild(coroa);

  setTimeout(() => {
    el.innerHTML = "";
  }, 2000);
}

function iniciarCoroaLoop() {
  estourarCoroaFinal(); // dispara imediatamente
  coroaInterval = setInterval(estourarCoroaFinal, 3000); // repete a cada 3 segundos
}

function pararCoroaLoop() {
  clearInterval(coroaInterval);
}

// ==================================================
// FUN√á√ÉO: mostrarTelaMotivacional
// Descri√ß√£o: Exibe tela final com mensagem personalizada
// ==================================================
function mostrarTelaMotivacional() {
  const nomeJogador = localStorage.getItem("nomeJogador") || "Jogador";

  const nomeFinal = document.getElementById("nomeFinal");
  const nomeFinal2 = document.getElementById("nomeFinal2");

  if (nomeFinal) nomeFinal.textContent = nomeJogador;
  if (nomeFinal2) nomeFinal2.textContent = nomeJogador;

  transicaoDeTela("vitoriaFinalArea", "telaMotivacional");
}

// ==================================================
// FRASES DE INTERA√á√ÉO COM O JOGADOR
// Descri√ß√£o: Mensagens din√¢micas para cada situa√ß√£o do jogo
// ==================================================
const kickeItDown = [
  "üîª Chutou baixo! Tenta mais alto.",
  "üéØ Ainda n√£o, sobe esse numero!",
  "üòéQuase l√°, tenta um pouco mais alto!",
  "üßäT√° frio, mas sobe mais um pouco!",
  "üî•T√° esquentando, mas tenta mais alto!",
];

const kickedUp = [
  "üî∫ Chutou alto! Tenta mais baixo.",
  "üéØAinda n√£o, desce esse numero!",
  "üòéQuase l√°, tenta um pouco mais baixo!",
  "üßäT√° frio, mas desce mais um pouco!",
  "üî•T√° esquentando, mas tenta mais baixo!",
];

const victory = [
  "üéâ Parab√©ns!, voc√™ acertou, vamos para Proxima?",
  "üëè Mandou bem, acertou em cheio.",
  "üí™ Voc√™ √© bom nisso, acertou em cheio",
  "üéâ Voc√™ √© fera! vamos para o proximo nivel.",
];

const defait = [
  "üíÄ Game Over! Tente novamente.",
  "üòµ‚Äçüí´ N√£o foi dessa vez, mas n√£o desista.",
  "üëª O numero secreto te assombrou dessa vez, tente novamente.",
  "üí• Voc√™ errou! mas n√£o desista, tente novamente.",
];

const incentive = [
  "üöÄ Vamos l√°, voc√™ consegue!",
  "üî• N√£o desista, voc√™ est√° quase l√°!",
  "üåü Acredite em si mesmo, voc√™ √© capaz!",
  "üí° Cada tentativa te aproxima do sucesso!",
];

const attemptPhrases5 = [
  `üéØ Voc√™ ainda tem {X} tentativas. Respira e vai com calma.`,
  `üí™ T√° tranquilo! {X} chances pra mostrar seu talento.`,
  `üß† Use a cabe√ßa, ainda tem {X} tentativas pra acertar.`,
  `üòé Jogo s√≥ come√ßou! {X} chances na manga.`,
  `üöÄ Bora aquecer! Ainda restam {X} tentativas.`,
];

const attemptPhrases3 = [
  `‚ö†Ô∏è S√≥ {X} tentativas restantes. Come√ßa a focar!`,
  `‚è≥ T√° ficando apertado‚Ä¶ {X} chances pra virar o jogo.`,
  `üîç Pensa bem! S√≥ restam {X} tentativas.`,
  `üß© T√° na metade do caminho. {X} chances pra resolver.`,
  `üéÆ Jogo t√° pegando ritmo! {X} tentativas restantes.`,
];

const attemptPhrases1 = [
  `üö® √öltima chance! √â agora ou nunca.`,
  `üí£ S√≥ {X} tentativa! Cada palpite conta.`,
  `üßä T√° no limite! {X} chance pra salvar o jogo.`,
  `üî• Tudo ou nada! {X} tentativa restantes.`,
  `üéØ Mira com precis√£o‚Ä¶ s√≥ {X} chance sobrando`,
];

const outOfBounds = [
  "üß† Esse n√∫mero nem existe nesse n√≠vel, campe√£o!",
  "üòÖ T√° zuando, mane? Escolhe um n√∫mero v√°lido!",
  "üìâ Esse chute foi t√£o fora que saiu do jogo.",
  "üö´ N√∫mero inv√°lido! Joga dentro das regras, vai.",
];

const Bozz = [
  "üèÜ Voc√™ venceu o chef√£o!",
  "üéâ Parab√©ns, campe√£o! Voc√™ dominou todos os n√≠veis.",
  "üëë Agora √© oficial: voc√™ √© o mestre dos n√∫meros!",
];
const gameOver = [
  "üíÄ O universo te apagou. Tudo recome√ßa.",
  "üß† Brilhante... se errar fosse talento, voc√™ seria campe√£o.",
  "üöÄ A nave explodiu. Miss√£o abortada.",
  "üîÅ Game Over. Mas a pr√≥xima tentativa pode ser lend√°ria.",
];

// ==================================================
// FUN√á√ÉO: iniciarJogo
// Descri√ß√£o: Inicia o jogo e exibe avatar gerado
// ==================================================
function iniciarJogo() {
  const nomeInput = document.getElementById("nome");
  const nome = nomeInput?.value.trim();

  if (!nome || nome.length < 3) {
    alert("Digite um nome v√°lido com pelo menos 3 caracteres!");
    return;
  }

  const avatar = document.getElementById("avatar");
  if (avatar) {
    avatar.src = `https://api.dicebear.com/7.x/bottts/svg?seed=${encodeURIComponent(nome)}`;
    avatar.style.display = "block";
  }

  localStorage.setItem("nomeJogador", nome); // salva para uso posterior
  iniciarNivel();
}

// ==================================================
// FUN√á√ÉO: iniciarNivel
// Descri√ß√£o: Define n√∫mero secreto, tentativas e atualiza interface
// ==================================================
function iniciarNivel() {
  const min = 1;
  const max = multipliedByLevel(currentLevel);

  number = getNumberRandon(min, max);
  attempts = Math.ceil(Math.log2(max - min + 1));
  numberOfGuesses = 0;
  history = [];

  const nivelInfo = document.getElementById("nivelInfo");
  if (nivelInfo) {
    nivelInfo.innerHTML = `
      üß† N√≠vel ${currentLevel} ‚Äî Adivinhe entre ${min} e ${max}.<br>
      Voc√™ tem ${attempts} tentativas.
    `;
  }

  const mensagemJogo = document.getElementById("mensagemJogo");
  if (mensagemJogo) mensagemJogo.textContent = "";

  const historico = document.getElementById("historico");
  if (historico) historico.textContent = "";

  atualizarVidas();
}

// ==================================================
// FUN√á√ÉO: jogar
// Descri√ß√£o: Processa o palpite do jogador, verifica acerto, atualiza vidas e controla transi√ß√µes
// ==================================================
async function jogar() {
  if (estadoDeTransicao) return;
  const palpite = parseInt(document.getElementById("palpite").value);
  const mensagem = document.getElementById("mensagemJogo");
  const historico = document.getElementById("historico");

  // Valida√ß√£o do palpite
  if (isNaN(palpite)) {
    mensagem.innerHTML = "üö´ Digite um n√∫mero v√°lido!";
    return;
  }

  limparInputPalpite();

  const min = 1;
  const max = multipliedByLevel(currentLevel);

  // Verifica se o palpite est√° fora do intervalo permitido
  if (palpite < min || palpite > max) {
    mensagem.innerHTML = randomPhrase(outOfBounds);
    return;
  }

  // Verifica se o n√∫mero j√° foi tentado
  if (history.includes(palpite)) {
    mensagem.innerHTML = "‚ö†Ô∏è Voc√™ j√° tentou esse n√∫mero!";
    return;
  }

  history.push(palpite);
  numberOfGuesses++;
  const remainingAttempts = attempts - numberOfGuesses;

  // ==================================================
  // PALPITE CORRETO
  // ==================================================
  if (palpite === number) {
  limparInputPalpite();
  currentLevel++;

  try {
    await fetch(`${API_URL}/api/atualizar-nivel`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        id: nomeJogador,
        nivelAtual: currentLevel,
        vidas: lives,
      }),
    });
    await carregarRanking();
  } catch (err) {}

  estadoDeTransicao = true;

  if (currentLevel > 10) {
    // Vit√≥ria final
    transicaoDeTela("gameArea", "vitoriaFinalArea");
    iniciarConfetesLoop();
    iniciarCoroaLoop();
    document.getElementById("mensagemFinalVitoria").innerHTML = `
      ${randomPhrase(Bozz)}<br> O n√∫mero era ${number}.<br> üëë Voc√™ zerou o jogo!
    `;
  } else {
    // Vit√≥ria comum
    transicaoDeTela("gameArea", "vitoriaArea"); 
    iniciarConfetesLoop();
    iniciarTrofeuLoop();
    document.getElementById("mensagemVitoria").innerHTML = `
      ${randomPhrase(victory)}<br> O n√∫mero era ${number}.<br> üéâ Vamos para o n√≠vel ${currentLevel}...
    `;
  }

  return;
}

  // ==================================================
  // PALPITE INCORRETO ‚Äî mostra dica
  // ==================================================
  if (palpite < number) {
    mensagem.innerHTML = `${randomPhrase(kickeItDown)} <br>
    ${tentativePhraseGenerator(remainingAttempts)}`;
  } else {
    mensagem.innerHTML = `${randomPhrase(
      kickedUp
    )} <br> ${tentativePhraseGenerator(remainingAttempts)}`;
  }

  // Exibe hist√≥rico se modo f√°cil estiver ativado
  if (historicalShow) {
    historico.innerHTML = `üìú Palpites anteriores: ${history.join(", ")}`;
  }

  document.getElementById("palpite").value = "";

  // ==================================================
  // VERIFICA SE ACABARAM AS TENTATIVAS
  // ==================================================
  if (remainingAttempts === 0) {
    lives--;
    atualizarVidas();

    const nomeJogador = localStorage.getItem("nomeJogador");

    if (lives === 0) {
      // Game Over
      currentLevel = 1;
      estadoDeTransicao = true;

      const mensagemFinal = randomPhrase(gameOver);
      transicaoDeTela("gameArea", "gameOverArea");
      iniciarGameOverLoop();
      document.getElementById(
        "mensagemFinal"
      ).innerHTML = `${mensagemFinal} <br> O n√∫mero era ${number}.`;

      document.getElementById("palpite").disabled = true;
      document.getElementById("enviarPalpite").disabled = true;

      limparInputPalpite();
      return;
    }
    if (lives > 0) {
      // Perdeu uma vida
      estadoDeTransicao = true;
      transicaoDeTela("gameArea", "vidaPerdidaArea");
      iniciarCoracaoLoop();
      document.getElementById(
        "mensagemVidaPerdida"
      ).innerHTML = `${randomPhrase(
        defait
      )}<br> O n√∫mero secreto era ${number}. <br> Vidas restantes: ${lives} ‚ù§Ô∏è`;
      return;
    }
  }
}

// ==================================================
// FUN√á√ïES AUXILIARES
// ==================================================

// Gera n√∫mero aleat√≥rio entre min e max
function getNumberRandon(min, max) {
  return Math.floor(Math.random() * (max - min + 1)) + min;
}

// Define o intervalo de n√∫meros com base no n√≠vel
function multipliedByLevel(level) {
  if (level <= 5) return level * 20;
  if (level <= 9) return level * 100;
  return 1000;
}

// Seleciona frase aleat√≥ria de um array
function randomPhrase(array) {
  return array[Math.floor(Math.random() * array.length)];
}

// Gera frase de incentivo com base nas tentativas restantes
function tentativePhraseGenerator(remainingAttempts) {
  const selectedPhrases =
    remainingAttempts >= 5
      ? attemptPhrases5
      : remainingAttempts >= 2
      ? attemptPhrases3
      : attemptPhrases1;

  return randomPhrase(selectedPhrases).replace("{X}", remainingAttempts);
}

// ==================================================
// EVENTO: Enter no input de palpite
// ==================================================
const inputPalpite = document.getElementById("palpite");
if (inputPalpite) {
  inputPalpite.addEventListener("keydown", (event) => {
    if (event.key === "Enter") {
      event.preventDefault();
      jogar();
    }
  });
}

